<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Streak</title>
  <script src="https://unpkg.com/@telegram-web-apps/webapp@1.0.0/dist/index.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-blue-100 min-h-screen flex flex-col justify-center items-center">
  <div class="bg-white rounded-xl p-6 shadow-md text-center w-11/12 max-w-md">
    <h2 class="text-2xl font-bold mb-4">Daily Streak</h2>
    <p class="text-lg" id="streak-info">Loading...</p>
    <button id="claim-btn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full">Claim</button>
  </div>

  <script type="module">
    // Handle the initialization of the app
    async function initApp() {
      const streakInfo = document.getElementById("streak-info");
      const claimBtn = document.getElementById("claim-btn");

      const isDev = false; // Set to true for testing without Telegram app

      let user;
      if (isDev) {
        user = { id: "devtest123", first_name: "DevUser", username: "devuser" };
        console.log("Running in DEV mode with mock user", user);
      } else {
        // Wait a moment for iOS to finish loading SDK
        await new Promise(r => setTimeout(r, 100));

        if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe || !window.Telegram.WebApp.initDataUnsafe.user) {
          streakInfo.innerText = "Please open this app inside Telegram to use the streak feature.";
          claimBtn.style.display = "none";
          return;
        }

        const tg = window.Telegram.WebApp;
        tg.ready();
        user = tg.initDataUnsafe.user;
      }

      // Mock user data for testing
      const streakData = {
        streakDay: 1,
        coins: 0,
        lastClaimed: null
      };

      async function loadStreak() {
        const lastClaimed = streakData.lastClaimed ? streakData.lastClaimed.toDateString() : null;
        const today = new Date();

        if (!lastClaimed || lastClaimed !== today.toDateString()) {
          streakInfo.innerText = `Day ${streakData.streakDay} - +${streakData.streakDay * 100} Coins`;
          claimBtn.disabled = false;
          claimBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
          claimBtn.classList.add("bg-blue-500", "hover:bg-blue-600");
        } else {
          streakInfo.innerText = `Already claimed today! Come back tomorrow.`;
          claimBtn.disabled = true;
          claimBtn.classList.remove("bg-blue-500", "hover:bg-blue-600");
          claimBtn.classList.add("bg-gray-400", "cursor-not-allowed");
        }
      }

      claimBtn.addEventListener("click", async () => {
        const coinsToAdd = streakData.streakDay * 100;

        // Update mock user data
        streakData.coins += coinsToAdd;
        streakData.streakDay = streakData.streakDay >= 7 ? 1 : streakData.streakDay + 1;
        streakData.lastClaimed = new Date();

        alert(`Claimed +${coinsToAdd} coins!`);
        location.reload();
      });

      await loadStreak();
    }

    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
