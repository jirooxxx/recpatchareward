<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Streak</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/@telegram-web-apps/webapp@1.0.0/dist/index.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-blue-100 min-h-screen flex flex-col justify-center items-center">
  <div class="bg-white rounded-xl p-6 shadow-md text-center w-11/12 max-w-md">
    <h2 class="text-2xl font-bold mb-4">Daily Streak</h2>
    <p class="text-lg" id="streak-info">Loading...</p>
    <button id="claim-btn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full">Claim</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function initApp() {
      const streakInfo = document.getElementById("streak-info");
      const claimBtn = document.getElementById("claim-btn");

      try {
        if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe || !window.Telegram.WebApp.initDataUnsafe.user) {
          throw new Error("Telegram WebApp environment not detected.");
        }

        const tg = window.Telegram.WebApp;
        tg.ready();

        const user = tg.initDataUnsafe.user;
        const uid = user.id.toString();
        const userRef = doc(db, "users", uid);

        async function setupUser() {
          const snap = await getDoc(userRef);
          if (!snap.exists()) {
            await setDoc(userRef, {
              name: user.first_name,
              username: user.username || "",
              coins: 0,
              streakDay: 1,
              lastClaimed: null,
              tasks: {
                twitter: false,
                telegram: false,
                discord: false,
                youtube: false
              }
            });
          }
        }

        async function loadStreak() {
          const snap = await getDoc(userRef);
          const data = snap.data();
          const lastClaimed = data.lastClaimed ? data.lastClaimed.toDate() : null;
          const today = new Date();

          if (!lastClaimed || lastClaimed.toDateString() !== today.toDateString()) {
            streakInfo.innerText = `Day ${data.streakDay} - +${data.streakDay * 100} Coins`;
            claimBtn.disabled = false;
            claimBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            claimBtn.classList.add("bg-blue-500", "hover:bg-blue-600");
          } else {
            streakInfo.innerText = `Already claimed today! Come back tomorrow.`;
            claimBtn.disabled = true;
            claimBtn.classList.remove("bg-blue-500", "hover:bg-blue-600");
            claimBtn.classList.add("bg-gray-400", "cursor-not-allowed");
          }
        }

        claimBtn.addEventListener("click", async () => {
          const snap = await getDoc(userRef);
          const data = snap.data();
          const coinsToAdd = data.streakDay * 100;

          await updateDoc(userRef, {
            coins: data.coins + coinsToAdd,
            streakDay: data.streakDay >= 7 ? 1 : data.streakDay + 1,
            lastClaimed: Timestamp.now()
          });

          alert(`Claimed +${coinsToAdd} coins!`);
          location.reload();
        });

        await setupUser();
        await loadStreak();
      } catch (error) {
        console.error("Initialization error:", error);
        streakInfo.innerText = "Please open this app inside Telegram to use the streak feature.";
        claimBtn.style.display = "none";
      }
    }

    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
